{{ define "main" }}
<article class="markdown book-article">
  <h1>{{ .Title }}</h1>

  {{ .Content }}

  {{ if .Sections }}
    {{/* Top-level legislation page - show year summaries */}}
    {{ range .Sections }}
      <h2><a href="{{ .Permalink }}">{{ .LinkTitle }}</a></h2>
      {{ partial "legislation-banner.html" (dict "bills" .Pages "baseURL" .Permalink) }}
    {{ end }}
  {{ else }}
    {{/* Year subsection page - show bill table */}}
    {{ if .Pages }}
    {{ $bills := .Pages }}

    {{ partial "legislation-banner.html" (dict "bills" $bills) }}

    {{/* Stage definitions - ordered from most to least advanced */}}
    {{ $stageGroups := slice
      (dict "name" "Signed into Law" "statuses" (slice "Chapter Number Assigned"))
      (dict "name" "Near Passage" "statuses" (slice "At Presidents Desk Upon Adjournment" "In House Conference Committee" "At House Desk Upon Adjournment"))
      (dict "name" "Awaiting Floor Vote" "statuses" (slice "Senate Desk - Awaiting Third Reading" "House Desk - Awaiting First Reading"))
      (dict "name" "In Senate Committee" "statuses" (slice "In Senate Committee"))
      (dict "name" "In House Committee" "statuses" (slice "In House Committee"))
      (dict "name" "Failed" "statuses" (slice "Senate Desk - Failed" "House Desk - Failed"))
    }}

    {{ range $stageGroups }}
      {{ $stageName := .name }}
      {{ $stageStatuses := .statuses }}
      {{ $stageBills := slice }}
      {{ range $bills }}
        {{ if in $stageStatuses (.Params.status | default "") }}
          {{ $stageBills = $stageBills | append . }}
        {{ end }}
      {{ end }}
      {{ if $stageBills }}
      <h2 id="{{ $stageName | urlize }}">{{ $stageName }}</h2>
      <p><em>{{ len $stageBills }} bill{{ if ne (len $stageBills) 1 }}s{{ end }}</em></p>
      <table>
        <thead>
          <tr>
            <th>Bill</th>
            <th>Status</th>
            <th>Sponsors</th>
          </tr>
        </thead>
        <tbody>
          {{ range sort $stageBills "Title" }}
          <tr>
            {{ $billPath := .RelPermalink | replaceRE "/$" "" }}{{ $newsCount := 0 }}{{ range where site.RegularPages "Section" "news-coverage" }}{{ if findRE (printf `\]\(%s\)` $billPath) .RawContent }}{{ $newsCount = add $newsCount 1 }}{{ end }}{{ end }}
            <td><a href="{{ .Permalink }}" style="font-size:1.1em;font-weight:bold">{{ .Title }}</a><br>{{ with .Params.catch_line }}{{ . }}{{ else }}{{ .Plain | replaceRE (printf "^%s\\s*" .Title) "" | truncate 120 }}{{ end }}{{ with .Params.testimony }} <em style="white-space:nowrap">{{ len . }} testimon{{ if eq (len .) 1 }}y{{ else }}ies{{ end }}</em>{{ end }} Â· <em style="white-space:nowrap">{{ $newsCount }} article{{ if ne $newsCount 1 }}s{{ end }}</em></td>
            <td>{{ .Params.status }}</td>
            <td>{{ with .Params.sponsors }}{{ range $i, $s := first 3 . }}{{ if $i }}, {{ end }}{{ with site.GetPage (printf "/people/%s" $s.slug) }}<a href="{{ .RelPermalink }}">{{ $s.name }}</a>{{ else }}{{ $s.name }}{{ end }}{{ end }}{{ if gt (len .) 3 }} +{{ sub (len .) 3 }} more{{ end }}{{ end }}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
      {{ end }}
    {{ end }}
    {{ end }}
  {{ end }}
</article>
{{ end }}
