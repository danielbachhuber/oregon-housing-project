{{ define "main" }}
<article class="markdown book-article">
  <h1>{{ .Title }}</h1>

  {{ .Content }}

  {{ if .Sections }}
    {{/* Parent page: show year-by-year summary */}}
    {{ range .Sections.ByDate.Reverse }}
      {{ $articles := where .Pages "Params.bookHidden" true }}
      {{ $count := len $articles }}
      <h2><a href="{{ .Permalink }}">{{ .LinkTitle }}</a></h2>
      <p>{{ $count }} article{{ if ne $count 1 }}s{{ end }}</p>

      {{ $sources := newScratch }}
      {{ $authors := newScratch }}
      {{ range $articles }}
        {{ $src := .Params.source | default "Unknown" }}
        {{ $sources.Add $src 1 }}
        {{ $author := .Params.author | default "Unknown" }}
        {{ $authors.Add $author 1 }}
      {{ end }}

      <p><strong>By publication:</strong> {{ $first := true }}{{ range $src, $count := $sources.Values }}{{ if not $first }}, {{ end }}{{ $src }} ({{ $count }}){{ $first = false }}{{ end }}</p>
      <p><strong>By author:</strong> {{ $first := true }}{{ range $author, $count := $authors.Values }}{{ if not $first }}, {{ end }}{{ $author }} ({{ $count }}){{ $first = false }}{{ end }}</p>
    {{ end }}
  {{ else }}
    {{/* Year page: show article cards */}}
    {{ range .Pages.ByDate.Reverse }}
    <div style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--gray-200);">
      <h3 style="margin: 0 0 0.25rem 0;"><a href="{{ .Permalink }}">{{ .Title }}</a></h3>
      <small style="color: var(--gray-600); font-style: italic;">{{ .Params.source }} · {{ .Date.Format "January 2, 2006" }}{{ with .Params.author }} · {{ . }}{{ end }}</small>
      <p style="margin: 0.5rem 0 0 0;">{{ .Plain | replaceRE (printf "(?i)^%s\\s*" .Title) "" | truncate 200 }}</p>
    </div>
    {{ end }}
  {{ end }}
</article>
{{ end }}
